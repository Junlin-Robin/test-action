name: Create Tag And Deploy In PROD_ENV

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  createTag:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh


      - name: Setup Git
        run: |
          echo "ğŸ  Setting global git config informations"
          git config --global user.email "347258143@qq.com"
          git config --global user.name "Github-action"
          gh auth setup-git

      - name: Create new branch for version upgrade
        run: |
          git checkout -b "version-upgrade"
          git reset --hard origin/master

          LOG_FILE_PATTERN=".versions/*.log.md"
          LOG_FILE_NAME=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E $LOG_FILE_PATH)
          VERSION_TYPE=$(grep 'VERSION_TYPE' ".version/${LOG_FILE_NAME}.type" | cut -d '=' -f2) || VERSION_TYPE=patch
          content=$(cat .version/$LOG_FILE_NAME)
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          echo "CONTENT=$content" >> $GITHUB_ENV
          echo "VERSION_TYPE=$VERSION_TYPE" >> $GITHUB_ENV

          npm version $VERSION_TYPE -m "Upgrade to %s due to PR merge"
          git push origin version-upgrade

          TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          echo "TAG_NAME=$TAG" >> $GITHUB_ENV
          git push origin $TAG

      - name: Create Pull Request
        run: |
          gh pr create --base master --head version-upgrade --title "Auto Version Upgrade" --body "Automatically upgrade version due to PR merge."

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: Release ${{ env.TAG_NAME }}
          body: ${{ env.CONTENT }}
          draft: false
          prerelease: false


  deploy-in-production:
    needs: createTag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: yarn

      - name: Lint
        run: yarn run lint
      
      - name: Build
        run: |
          ENV=production
          echo "Current environment is production ğŸ­"
          echo "ENV=$ENV" >> $GITHUB_ENV

          # CURRENT_TAG=${{ needs.create-tag.outputs.TAG }}
          # echo "Current tag is $CURRENT_TAG ğŸŒ¿"

          echo "OUT_DIR=$(grep 'VITE_BUILD_OUT_DIR' .env.$ENV | cut -d '=' -f2)" >> $GITHUB_ENV

          git checkout master

          yarn run build -- --mode $ENV

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages     # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
          folder: ${{ env.OUT_DIR }} # éƒ¨ç½²ç›®å½•è§é…ç½®
          target-folder: /${{ env.ENV }} # éƒ¨ç½²æ ¹ç›®å½•
          clean: true     # å…ˆæ¸…ç†ä¹‹å‰çš„éƒ¨ç½²
          token: ${{ secrets.GITHUB_TOKEN }}

    




      
