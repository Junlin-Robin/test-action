name: Create Tag And Deploy In PROD_ENV

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  createTag:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Setup Git
        run: |
          echo "ğŸ  Setting global git config informations"
          git config --global user.email "347258143@qq.com"
          git config --global user.name "Github-action"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Create and Push Tag
        run: |
          # ç”Ÿæˆæ–°çš„tagæ ‡ç­¾ï¼Œæ ¼å¼ä¸ºv-[YYYY-MM-DD]-[index]
          # echo "ğŸª„ Start create new tag from latest master"

          # echo "ğŸ” Searching last tag name..."
          # LAST_TAG_NAME=$(git describe --tags `git rev-list --tags --max-count=1`) || LAST_TAG_NAME="v-$(date +%Y%m%d)-0"
          # echo "ğŸ’¡ Last tag is $LAST_TAG_NAME"

          # echo "âŒ›ï¸ Creating a new tag..."
          # # åŒ¹é…ä¸Šä¸€ä¸ªtagçš„åºåˆ—å·
          # declare -i LAST_TAG_INDEX
          # LAST_TAG_INDEX=${LAST_TAG_NAME##*-} || LAST_TAG_INDEX=0
          # # ç”Ÿæˆæ–°çš„tagåç§°
          # NEW_TAG_NAME="v-$(date +%Y%m%d)-$((LAST_TAG_INDEX + 1))"
          # echo "ğŸ’¡ New tag is $NEW_TAG_NAME"

          # echo "::set-output name=TAG::$NEW_TAG_NAME"

          echo "ğŸš€ Pushing new tag to origin..."
          git checkout master
          npm version patch -m "Upgrade to %s for reasons"
          # git tag $NEW_TAG_NAME -m 'test for only'
          git push "https://github.com/Junlin-Robin/test-action.git"
          echo "âœ… Finish create and push tag job"

  deploy-in-production:
    needs: createTag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–æ‰€æœ‰å†å²ä»¥ä¾¿æ­£ç¡®ç”Ÿæˆæ ‡ç­¾

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Lint
        run: yarn run lint

      - name: Install Dependencies
        run: yarn
      
      - name: Build
        run: |
          ENV=production
          echo "Current environment is production ğŸ­"
          echo "ENV=$ENV" >> $GITHUB_ENV

          CURRENT_TAG=${{ needs.create-tag.outputs.TAG }}
          echo "Current tag is $CURRENT_TAG ğŸŒ¿"

          echo "OUT_DIR=$(grep 'REACT_BUILD_OUT_DIR' .env.$ENV | cut -d '=' -f2)" >> $GITHUB_ENV

          git checkout master

          yarn run build -- --mode $ENV

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages     # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
          folder: ${{ env.OUT_DIR }} # éƒ¨ç½²ç›®å½•è§é…ç½®
          target-folder: /${{ env.ENV }} # éƒ¨ç½²æ ¹ç›®å½•
          clean: true     # å…ˆæ¸…ç†ä¹‹å‰çš„éƒ¨ç½²
          token: ${{ secrets.GITHUB_TOKEN }}

    




      
