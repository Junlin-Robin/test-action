name: Create Tag And Deploy In PROD_ENV

on:
  pull_request:
    branches:
      - master
    types: [closed]

jobs:
  create-tag:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 确保获取所有历史以便正确生成标签

      - name: Setup Git
        run: |
          echo "🏠 Setting global git config informations"
          git config --global user.email "347258143@qq.com"
          git config --global user.name "Junlin-Robin"

      - name: Create and Push Tag
        run: |
          # 生成新的tag标签，格式为v-[YYYY-MM-DD]-[index]
          echo "🪄 Start create new tag from latest master"

          echo "🔍 Searching last tag name..."
          LAST_TAG_NAME=$(git describe --tags --abbrev=0) || LAST_TAG_NAME="v-$(date +%Y%m%d)-0"
          echo "💡 Last tag is ${LAST_TAG_NAME}"

          echo "⌛️ Creating a new tag..."
          # 匹配上一个tag的序列号
          declare -i LAST_TAG_INDEX
          LAST_TAG_INDEX=${LAST_TAG_NAME##*-} || LAST_TAG_INDEX=0
          # 生成新的tag名称
          NEW_TAG_NAME="v-$(date +%Y%m%d)-$((LAST_TAG_INDEX + 1))"
          echo "💡 New tag is ${NEW_TAG_NAME}"

          echo "🚀 Pushing new tag to origin..."
          git checkout master
          git tag $NEW_TAG_NAME
          git push "https://github.com/Junlin-Robin/test-action.git" $NEW_TAG_NAME
          echo "✅ Finish create and push tag job"

      # 111222
      # - name: Deploy production environment project
      #   run: 